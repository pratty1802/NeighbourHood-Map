<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      html,
      body {
        font-family: Arial, sans-serif;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100%;
        position: absolute;
        bottom: 0px;
        left: 362px;
        right: 0px;
      }

      .container {
        height: 100%;
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="search-box">
        <h1>LoVe FoR GoA</h1>
        <p>Filter: <input type="text" placeholder="Search" data-bind="textInput: filter"></p>
        <ul  data-bind="foreach: filteredData">
           <li> <button data-bind="visible: true, text: place, event: {click: $parent.displayInfo}"></button></li>
        </ul>
      </div>
    </div>
    <div id="map"></div>
    <script>
      var map;
      var largeInfowindow;
      var markers=[];
      function initMap() {
        // Constructor creates a new map - only center and zoom are required.
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 15.6580, lng: 73.8549},
          zoom: 11
        });
        var geocoder = new google.maps.Geocoder();
         largeInfowindow = new google.maps.InfoWindow();
        var defaultIcon = makeMarkerIcon('0091ff');
        var highlightedIcon = makeMarkerIcon('FFFF24');
        for(var i=0;i<places.length;i++){
          var address=places[i].place;
          if (geocoder) {
            geocoder.geocode({
              'address': address
            }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                  if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                      var marker = new google.maps.Marker({
                      position: results[0].geometry.location,
                      map: map,
                      icon: defaultIcon,
                      title: results[0].formatted_address,
                      animation: google.maps.Animation.DROP
                    });
                  //  populateInfoWindow(marker,largeInfowindow);
                    markers.push(marker);
                    places[i].marker=marker;
                    marker.addListener('click', function() {
                        populateInfoWindow(this, largeInfowindow);
                    });
                    marker.addListener('mouseover', function() {
                        this.setIcon(highlightedIcon);
                    });
                    marker.addListener('mouseout', function() {
                        this.setIcon(defaultIcon);
                    });
                }
          }
        });
      }
    }
    for(var i=0;i<markers.length;i++)
    {
      markers[i].title=places[i].place;
    }
  };


  function makeMarkerIcon(markerColor) {
      var markerImage = new google.maps.MarkerImage(
        'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
        '|40|_|%E2%80%A2',
        new google.maps.Size(21, 34),
        new google.maps.Point(0, 0),
        new google.maps.Point(10, 34),
        new google.maps.Size(21,34));
      return markerImage;
    };
    function populateInfoWindow(marker, infowindow) {
    // Check to make sure the infowindow is not already opened on this marker.
    if (infowindow.marker != marker) {
      // Clear the infowindow content to give the streetview time to load.
      infowindow.setContent('');
      infowindow.marker = marker;
      // Make sure the marker property is cleared if the infowindow is closed.
      infowindow.addListener('closeclick', function() {
        infowindow.marker = null;
      });


      var wikiRequestTimeout=setTimeout(function(){
            infowindow.setContent("Wikepedia links could not be loaded");
        },6000);

      var wikiURL='http://en.wikipedia.org/w/api.php?action=opensearch&search='+marker.title.split(" ")[0]+'&format=json&callback=?';   //error handling
          $.ajax({
            url:wikiURL,
            dataType:"jsonp",
            success:function(response){
            console.log(response);
            var articleList=response[1];
            var articleURL='http://en.wikipedia.org/wiki/'+articleList[0];
              infowindow.setContent('<h1>Wikepedia Link:</h1><li>'+
                          '<a href="'+articleURL+'">'+articleList[0]+'</a></li>');
            clearTimeout(wikiRequestTimeout);
    }
});

      // Open the infowindow on the correct marker.
      infowindow.open(map, marker);
    }
  };
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyAuRe0Zm4VI_5N4IqJM-AsokSNgBJCQIDM&v=3&callback=initMap">
    </script>
    <script src="js/lib/knockout-3.2.0.js"></script>
    <script src="js/lib/jquery.min.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
